{"ast":null,"code":"var _s = $RefreshSig$();\nimport { useEffect, useRef, useState, useCallback } from 'react';\nimport { useChatContext } from '../context/ChatContext';\nconst useWebSocket = () => {\n  _s();\n  const wsRef = useRef(null);\n  const reconnectTimeoutRef = useRef(null);\n  const [isConnected, setIsConnected] = useState(false);\n  const [reconnectAttempts, setReconnectAttempts] = useState(0);\n  const MAX_RECONNECT_ATTEMPTS = 5;\n  const RECONNECT_DELAY = 3000; // 8 seconds\n\n  const {\n    username,\n    isLoggedIn,\n    addMessage,\n    setMessageHistory,\n    setOnlineUsers\n  } = useChatContext();\n\n  // ‚úÖ Use environment variable or fallback to localhost\n  const WS_URL = process.env.REACT_APP_WS_URL;\n  const connect = useCallback(() => {\n    // stop if user not logged in or max attempts reached\n    if (!isLoggedIn || reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) return;\n\n    // close any existing socket before reconnecting\n    if (wsRef.current) {\n      wsRef.current.close();\n    }\n    const websocket = new WebSocket(WS_URL);\n    websocket.onopen = () => {\n      console.log('‚úÖ Connected to server');\n      setIsConnected(true);\n      setReconnectAttempts(0);\n      websocket.send(JSON.stringify({\n        type: 'join',\n        username\n      }));\n    };\n    websocket.onmessage = event => {\n      try {\n        const data = JSON.parse(event.data);\n        if (data.type === 'history') {\n          setMessageHistory(data.messages);\n        } else if (data.type === 'message') {\n          addMessage(data.message);\n        } else if (data.type === 'users') {\n          setOnlineUsers(data.count);\n        }\n      } catch (error) {\n        console.error('‚ö†Ô∏è Error parsing message:', error);\n      }\n    };\n    websocket.onerror = error => {\n      console.error('‚ö†Ô∏è WebSocket error:', error);\n    };\n    websocket.onclose = () => {\n      console.log('‚ùå Disconnected from server');\n      setIsConnected(false);\n\n      // attempt reconnection with delay\n      if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {\n        reconnectTimeoutRef.current = setTimeout(() => {\n          console.log(`üîÑ Reconnection attempt ${reconnectAttempts + 1}/${MAX_RECONNECT_ATTEMPTS}`);\n          setReconnectAttempts(prev => prev + 1);\n          connect(); // retry connect\n        }, RECONNECT_DELAY);\n      } else {\n        console.error('üö´ Max reconnection attempts reached');\n      }\n    };\n    wsRef.current = websocket;\n  }, [isLoggedIn, username, reconnectAttempts, addMessage, setMessageHistory, setOnlineUsers, WS_URL]);\n\n  // ‚úÖ Handle reconnection on attempts change\n  useEffect(() => {\n    if (reconnectAttempts > 0 && reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {\n      connect();\n    }\n  }, [reconnectAttempts, connect]);\n\n  // ‚úÖ Initial connect when user logs in or username changes\n  useEffect(() => {\n    if (!isLoggedIn || !username) return;\n\n    // cleanup before connecting\n    if (wsRef.current) {\n      wsRef.current.close();\n    }\n    setReconnectAttempts(0);\n    connect();\n    return () => {\n      if (wsRef.current) {\n        wsRef.current.close();\n        wsRef.current = null;\n      }\n      if (reconnectTimeoutRef.current) {\n        clearTimeout(reconnectTimeoutRef.current);\n      }\n    };\n  }, [isLoggedIn, username, connect]);\n\n  // ‚úÖ Send message helper\n  const sendMessage = useCallback(text => {\n    if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {\n      wsRef.current.send(JSON.stringify({\n        type: 'message',\n        text,\n        username\n      }));\n      return true;\n    }\n    console.warn('‚ö†Ô∏è WebSocket is not connected');\n    return false;\n  }, [username]);\n  return {\n    sendMessage,\n    isConnected,\n    reconnectAttempts\n  };\n};\n_s(useWebSocket, \"ZajSYl1EQFA+re5etP/lQqIJXA0=\", false, function () {\n  return [useChatContext];\n});\nexport default useWebSocket;","map":{"version":3,"names":["useEffect","useRef","useState","useCallback","useChatContext","useWebSocket","_s","wsRef","reconnectTimeoutRef","isConnected","setIsConnected","reconnectAttempts","setReconnectAttempts","MAX_RECONNECT_ATTEMPTS","RECONNECT_DELAY","username","isLoggedIn","addMessage","setMessageHistory","setOnlineUsers","WS_URL","process","env","REACT_APP_WS_URL","connect","current","close","websocket","WebSocket","onopen","console","log","send","JSON","stringify","type","onmessage","event","data","parse","messages","message","count","error","onerror","onclose","setTimeout","prev","clearTimeout","sendMessage","text","readyState","OPEN","warn"],"sources":["C:/Users/skk46/OneDrive/AppData/Desktop/chat-app-full/chat-app/frontend/src/hooks/useWebSocket.js"],"sourcesContent":["import { useEffect, useRef, useState, useCallback } from 'react';\r\nimport { useChatContext } from '../context/ChatContext';\r\n\r\nconst useWebSocket = () => {\r\n  const wsRef = useRef(null);\r\n  const reconnectTimeoutRef = useRef(null);\r\n\r\n  const [isConnected, setIsConnected] = useState(false);\r\n  const [reconnectAttempts, setReconnectAttempts] = useState(0);\r\n\r\n  const MAX_RECONNECT_ATTEMPTS = 5;\r\n  const RECONNECT_DELAY = 3000; // 8 seconds\r\n\r\n  const {\r\n    username,\r\n    isLoggedIn,\r\n    addMessage,\r\n    setMessageHistory,\r\n    setOnlineUsers,\r\n  } = useChatContext();\r\n\r\n  // ‚úÖ Use environment variable or fallback to localhost\r\n  const WS_URL = process.env.REACT_APP_WS_URL;\r\n\r\n\r\n  const connect = useCallback(() => {\r\n    // stop if user not logged in or max attempts reached\r\n    if (!isLoggedIn || reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) return;\r\n\r\n    // close any existing socket before reconnecting\r\n    if (wsRef.current) {\r\n      wsRef.current.close();\r\n    }\r\n\r\n    const websocket = new WebSocket(WS_URL);\r\n\r\n    websocket.onopen = () => {\r\n      console.log('‚úÖ Connected to server');\r\n      setIsConnected(true);\r\n      setReconnectAttempts(0);\r\n      websocket.send(JSON.stringify({ type: 'join', username }));\r\n    };\r\n\r\n    websocket.onmessage = (event) => {\r\n      try {\r\n        const data = JSON.parse(event.data);\r\n\r\n        if (data.type === 'history') {\r\n          setMessageHistory(data.messages);\r\n        } else if (data.type === 'message') {\r\n          addMessage(data.message);\r\n        } else if (data.type === 'users') {\r\n          setOnlineUsers(data.count);\r\n        }\r\n      } catch (error) {\r\n        console.error('‚ö†Ô∏è Error parsing message:', error);\r\n      }\r\n    };\r\n\r\n    websocket.onerror = (error) => {\r\n      console.error('‚ö†Ô∏è WebSocket error:', error);\r\n    };\r\n\r\n    websocket.onclose = () => {\r\n      console.log('‚ùå Disconnected from server');\r\n      setIsConnected(false);\r\n\r\n      // attempt reconnection with delay\r\n      if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {\r\n        reconnectTimeoutRef.current = setTimeout(() => {\r\n          console.log(\r\n            `üîÑ Reconnection attempt ${reconnectAttempts + 1}/${MAX_RECONNECT_ATTEMPTS}`\r\n          );\r\n          setReconnectAttempts((prev) => prev + 1);\r\n          connect(); // retry connect\r\n        }, RECONNECT_DELAY);\r\n      } else {\r\n        console.error('üö´ Max reconnection attempts reached');\r\n      }\r\n    };\r\n\r\n    wsRef.current = websocket;\r\n  }, [\r\n    isLoggedIn,\r\n    username,\r\n    reconnectAttempts,\r\n    addMessage,\r\n    setMessageHistory,\r\n    setOnlineUsers,\r\n    WS_URL,\r\n  ]);\r\n\r\n  // ‚úÖ Handle reconnection on attempts change\r\n  useEffect(() => {\r\n    if (reconnectAttempts > 0 && reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {\r\n      connect();\r\n    }\r\n  }, [reconnectAttempts, connect]);\r\n\r\n  // ‚úÖ Initial connect when user logs in or username changes\r\n  useEffect(() => {\r\n    if (!isLoggedIn || !username) return;\r\n\r\n    // cleanup before connecting\r\n    if (wsRef.current) {\r\n      wsRef.current.close();\r\n    }\r\n    setReconnectAttempts(0);\r\n    connect();\r\n\r\n    return () => {\r\n      if (wsRef.current) {\r\n        wsRef.current.close();\r\n        wsRef.current = null;\r\n      }\r\n      if (reconnectTimeoutRef.current) {\r\n        clearTimeout(reconnectTimeoutRef.current);\r\n      }\r\n    };\r\n  }, [isLoggedIn, username, connect]);\r\n\r\n  // ‚úÖ Send message helper\r\n  const sendMessage = useCallback(\r\n    (text) => {\r\n      if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {\r\n        wsRef.current.send(\r\n          JSON.stringify({\r\n            type: 'message',\r\n            text,\r\n            username,\r\n          })\r\n        );\r\n        return true;\r\n      }\r\n      console.warn('‚ö†Ô∏è WebSocket is not connected');\r\n      return false;\r\n    },\r\n    [username]\r\n  );\r\n\r\n  return { sendMessage, isConnected, reconnectAttempts };\r\n};\r\n\r\nexport default useWebSocket;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}